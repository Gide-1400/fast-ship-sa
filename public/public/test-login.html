<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - FastShip</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config/supabase.js"></script>
    <script src="assets/js/session-manager.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - FastShip</h1>

    <div class="result info">
        <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:</strong><br>
        <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    </div>

    <h2>Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <button class="test-btn" onclick="testLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø§Ø­Ù†</button>
    <button class="test-btn" onclick="testLoginCarrier()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒÙ†Ø§Ù‚Ù„</button>
    <button class="test-btn" onclick="createTestUser()">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ¨Ø§Ø±</button>

    <h2>Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ</h2>
    <button class="test-btn" onclick="checkSession()">ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
    <button class="test-btn" onclick="clearSessions()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button>
    <button class="test-btn" onclick="goToHome()">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

    <div id="results"></div>

    <script src="test-login.js"></script>
    <script>
        // Check system status on load
        document.addEventListener('DOMContentLoaded', async function() {
            await checkSystemStatus();
        });

        async function checkSystemStatus() {
            const statusDiv = document.getElementById('status');

            try {
                // Check Supabase
                if (!window.supabaseClient) {
                    statusDiv.innerHTML = 'âŒ Supabase ØºÙŠØ± Ù…ØªØµÙ„';
                    return;
                }

                // Check session
                const { data, error } = await window.supabaseClient.auth.getSession();
                if (error) {
                    statusDiv.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø³Ø© Supabase: ' + error.message;
                    return;
                }

                // Check session manager
                if (!window.sessionManager) {
                    statusDiv.innerHTML = 'âŒ Session Manager ØºÙŠØ± Ù…ØªÙˆÙØ±';
                    return;
                }

                await window.sessionManager.init();

                const isLoggedIn = window.sessionManager.isLoggedIn();
                const userType = window.sessionManager.getUserType();

                statusDiv.innerHTML = `
                    âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­<br>
                    ğŸ” Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${isLoggedIn ? 'Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„' : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}<br>
                    ğŸ‘¤ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                    ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${window.sessionManager.currentUser?.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                `;

            } catch (error) {
                statusDiv.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: ' + error.message;
            }
        }

        // Test functions
        async function testLogin() {
            addResult('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø§Ø­Ù†...');
            const success = await loginAsShipper();
            if (success) {
                addResult('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø§Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                setTimeout(() => checkSystemStatus(), 1000);
            } else {
                addResult('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø§Ø­Ù†', 'error');
            }
        }

        async function testLoginCarrier() {
            addResult('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ†Ø§Ù‚Ù„...');
            const success = await loginAsCarrier();
            if (success) {
                addResult('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ†Ø§Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                setTimeout(() => checkSystemStatus(), 1000);
            } else {
                addResult('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ†Ø§Ù‚Ù„', 'error');
            }
        }

        async function createTestUser() {
            addResult('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ¨Ø§Ø±...');
            const success = await createTestUser();
            if (success) {
                addResult('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                addResult('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        function checkSession() {
            addResult('ğŸ” ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...');
            checkSession();
            setTimeout(() => checkSystemStatus(), 500);
        }

        function clearSessions() {
            addResult('ğŸ§¹ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª...');
            clearSessions();
            setTimeout(() => checkSystemStatus(), 1000);
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Override console.log to show in results
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            addResult('ğŸ“ ' + message, 'info');
        };
    </script>
</body>
</html>