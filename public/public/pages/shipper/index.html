<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>لوحة التحكم - صاحب الشحنات | FastShip</title>
    <link rel="stylesheet" href="../../assets/css/custom.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../config/supabase.js"></script>
    <script src="../../assets/js/session-manager.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }
        .stat-card {
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body class='min-h-screen'>
    <!-- Header -->
    <header class='bg-white/10 backdrop-blur-md border-b border-white/20'>
        <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
            <div class='flex justify-between items-center h-16'>
                <div class='flex items-center'>
                    <a href='../../index.html' class='text-2xl font-bold text-white'>FastShip</a>
                    <span class='text-white/60 mr-3'>|</span>
                    <span class='text-white/80'>لوحة تحكم الشاحن</span>
                </div>
                <div class='flex items-center space-x-4 space-x-reverse'>
                    <!-- Messages -->
                    <div class='relative'>
                        <button onclick='openMessages()' class='text-white/80 hover:text-white transition-colors p-2'>
                            <i class='fas fa-comments text-lg'></i>
                            <span id='messageBadge' class='absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden'>0</span>
                        </button>
                    </div>
                    <!-- Notifications -->
                    <div class='relative'>
                        <button onclick='showNotifications()' class='text-white/80 hover:text-white transition-colors p-2'>
                            <i class='fas fa-bell text-lg'></i>
                            <span id='notificationBadge' class='absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden'>0</span>
                        </button>
                    </div>
                    <!-- Profile Menu -->
                    <div class='relative'>
                        <button onclick='toggleProfile()' class='flex items-center space-x-2 space-x-reverse text-white/80 hover:text-white transition-colors'>
                            <div class='w-8 h-8 bg-white/20 rounded-full flex items-center justify-center'>
                                <i class='fas fa-user text-sm'></i>
                            </div>
                            <span id='userName'>المستخدم</span>
                            <i class='fas fa-chevron-down text-sm'></i>
                        </button>
                        <div id='profileMenu' class='hidden absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50'>
                            <a href='../profile.html' class='block px-4 py-2 text-gray-700 hover:bg-gray-100'>
                                <i class='fas fa-user ml-2'></i>الملف الشخصي
                            </a>
                            <a href='../../index.html' class='block px-4 py-2 text-gray-700 hover:bg-gray-100'>
                                <i class='fas fa-home ml-2'></i>الصفحة الرئيسية
                            </a>
                            <div class='border-t my-1'></div>
                            <button onclick='logout()' class='w-full text-right px-4 py-2 text-red-600 hover:bg-red-50'>
                                <i class='fas fa-sign-out-alt ml-2'></i>تسجيل الخروج
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8'>
        <!-- Welcome Section -->
        <div class='text-center mb-8'>
            <h1 class='text-3xl font-bold text-white mb-2'>مرحبا بك <span id='welcomeName'>صاحب الشحنات</span>! 👋</h1>
            <p class='text-white/80'>إدارة شحناتك والبحث عن أفضل الناقلين</p>
        </div>

        <!-- Stats Cards -->
        <div class='grid grid-cols-1 md:grid-cols-4 gap-6 mb-6'>
            <div class='glass-card p-6 stat-card'>
                <div class='flex items-center justify-between'>
                    <div>
                        <p class='text-gray-200 text-sm'>الشحنات النشطة</p>
                        <p class='text-3xl font-bold text-white' id='activeShipments'>0</p>
                    </div>
                    <div class='w-12 h-12 bg-blue-500 bg-opacity-20 rounded-full flex items-center justify-center'>
                        <i class='fas fa-box text-blue-300 text-xl'></i>
                    </div>
                </div>
            </div>

            <div class='glass-card p-6 stat-card'>
                <div class='flex items-center justify-between'>
                    <div>
                        <p class='text-gray-200 text-sm'>الشحنات المكتملة</p>
                        <p class='text-3xl font-bold text-white' id='completedShipments'>0</p>
                    </div>
                    <div class='w-12 h-12 bg-green-500 bg-opacity-20 rounded-full flex items-center justify-center'>
                        <i class='fas fa-check-circle text-green-300 text-xl'></i>
                    </div>
                </div>
            </div>

            <div class='glass-card p-6 stat-card'>
                <div class='flex items-center justify-between'>
                    <div>
                        <p class='text-gray-200 text-sm'>الرسائل الجديدة</p>
                        <p class='text-3xl font-bold text-white' id='newMessages'>0</p>
                    </div>
                    <div class='w-12 h-12 bg-yellow-500 bg-opacity-20 rounded-full flex items-center justify-center'>
                        <i class='fas fa-envelope text-yellow-300 text-xl'></i>
                    </div>
                </div>
            </div>

            <div class='glass-card p-6 stat-card'>
                <div class='flex items-center justify-between'>
                    <div>
                        <p class='text-gray-200 text-sm'>التوفير الإجمالي</p>
                        <p class='text-3xl font-bold text-white' id='totalSavings'></p>
                    </div>
                    <div class='w-12 h-12 bg-purple-500 bg-opacity-20 rounded-full flex items-center justify-center'>
                        <i class='fas fa-dollar-sign text-purple-300 text-xl'></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class='grid grid-cols-1 lg:grid-cols-2 gap-6'>
            <!-- Quick Actions -->
            <div class='glass-card p-6'>
                <h2 class='text-xl font-bold text-white mb-6'>إجراءات سريعة</h2>
                <div class='space-y-4'>
                    <button onclick='addShipment()' class='w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-all transform hover:scale-105'>
                        <i class='fas fa-plus ml-2'></i>
                        إضافة شحنة جديدة
                    </button>

                    <button onclick='smartMatch()' class='w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-all transform hover:scale-105'>
                        <i class='fas fa-magic ml-2'></i>
                        البحث الذكي عن ناقل
                    </button>

                    <button onclick='openMessages()' class='w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg font-semibold transition-all transform hover:scale-105'>
                        <i class='fas fa-comments ml-2'></i>
                        الرسائل والإشعارات
                        <span class='bg-red-500 text-white text-xs px-2 py-1 rounded-full mr-2' id='messagesCount'>3</span>
                    </button>
                </div>
            </div>

            <!-- Recent Shipments -->
            <div class='glass-card p-6'>
                <div class='flex justify-between items-center mb-6'>
                    <h2 class='text-xl font-bold text-white'>الشحنات الأخيرة</h2>
                    <button onclick='viewShipments()' class='text-blue-200 hover:text-blue-100'>عرض الكل</button>
                </div>
                <div id='recentShipments'>
                    <!-- Shipments will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Available Carriers -->
        <div class='glass-card p-6 mt-6'>
            <div class='flex justify-between items-center mb-6'>
                <h2 class='text-xl font-semibold text-white'>الناقلون المتاحون</h2>
                <button onclick='refreshCarriers()' class='text-blue-300 hover:text-blue-200'>
                    <i class='fas fa-refresh ml-1'></i>تحديث
                </button>
            </div>
            <div id='availableCarriers'>
                <!-- Carriers will be loaded here -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await sessionManager.init();

            if (!sessionManager.isLoggedIn()) {
                window.location.href = '../pages/auth/login.html';
                return;
            }

            const userType = sessionManager.getUserType();
            if (userType !== 'shipper') {
                alert('هذه الصفحة مخصصة لأصحاب الشحنات فقط');
                window.sessionManager.goToDashboard();
                return;
            }

            // Load user info and data
            loadUserInfo();
            loadDashboardData();

            console.log('✅ Shipper dashboard loaded successfully');
        });

        function loadUserInfo() {
            const user = sessionManager.getCurrentUser();
            if (user) {
                const displayName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'المستخدم';
                document.getElementById('userName').textContent = displayName;
                document.getElementById('welcomeName').textContent = displayName;
            }
        }

        async function loadDashboardData() {
            try {
                await loadRecentShipments();
                await loadStats();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadStats() {
            try {
                const user = sessionManager.getCurrentUser();
                if (!user) return;

                // Load shipment stats
                const { data: shipments, error } = await window.supabaseClient
                    .from('shipments')
                    .select('status')
                    .eq('shipper_id', user.id);

                if (error) throw error;

                const active = shipments?.filter(s => s.status === 'active' || s.status === 'pending').length || 0;
                const completed = shipments?.filter(s => s.status === 'completed').length || 0;

                document.getElementById('activeShipments').textContent = active;
                document.getElementById('completedShipments').textContent = completed;

                // Mock data for messages and savings (will be implemented later)
                document.getElementById('newMessages').textContent = '0';
                document.getElementById('totalSavings').textContent = '';

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadRecentShipments() {
            try {
                const user = sessionManager.getCurrentUser();
                if (!user) return;

                const { data: shipments, error } = await window.supabaseClient
                    .from('shipments')
                    .select('*')
                    .eq('shipper_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(3);

                if (error) throw error;

                const container = document.getElementById('recentShipments');

                if (shipments && shipments.length > 0) {
                    container.innerHTML = shipments.map(shipment => 
                        `<div class='bg-white/5 p-4 rounded-lg'>
                            <div class='flex justify-between items-start mb-2'>
                                <h3 class='text-white font-medium'>${shipment.title || 'شحنة'}</h3>
                                <span class='bg-yellow-500 text-black text-xs px-2 py-1 rounded-full'>${getStatusText(shipment.status)}</span>
                            </div>
                            <p class='text-gray-300 text-sm mb-2'>
                                <i class='fas fa-route ml-1'></i>
                                من ${shipment.pickup_location || 'غير محدد'} إلى ${shipment.delivery_location || 'غير محدد'}
                            </p>
                            <div class='flex justify-between items-center text-sm text-gray-400'>
                                <span><i class='fas fa-weight-hanging ml-1'></i> ${shipment.weight || 0} كجم</span>
                                <span>${shipment.created_at ? new Date(shipment.created_at).toLocaleDateString('ar-SA') : ''}</span>
                            </div>
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = `<div class='text-center py-8 text-white/70'>
                        <i class='fas fa-box-open text-4xl mb-4'></i>
                        <p>لا توجد شحنات بعد</p>
                        <button onclick='addShipment()' class='mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg'>
                            إضافة أول شحنة
                        </button>
                    </div>`;
                }

            } catch (error) {
                console.error('Error loading shipments:', error);
                document.getElementById('recentShipments').innerHTML = `<div class='text-center py-8 text-white/70'>
                    <i class='fas fa-exclamation-triangle text-4xl mb-4'></i>
                    <p>حدث خطأ في تحميل الشحنات</p>
                </div>`;
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'active': 'نشط',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        // Action functions
        function addShipment() {
            window.location.href = 'add-shipment.html';
        }

        function smartMatch() {
            alert('جاري البحث الذكي عن أفضل ناقل لشحنتك...');
            // TODO: Implement smart matching
        }

        function openMessages() {
            window.location.href = 'messages.html';
        }

        function viewShipments() {
            window.location.href = 'shipments.html';
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج')) {
                sessionManager.logout();
            }
        }

        function toggleProfile() {
            document.getElementById('profileMenu').classList.toggle('hidden');
        }

        function showNotifications() {
            alert('نظام التنبيهات قيد التطوير');
        }

        function refreshCarriers() {
            alert('تحديث الناقلين قيد التطوير');
        }

        // Close profile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.relative')) {
                document.getElementById('profileMenu').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
